{% extends "base.html" %}

{% block app_content %}
  <h1>Dashboard for pull requests of <a href="{{ ''.join([repo_link]) }}" > {{ repo_link }} </a></h1>
  <table class="table table-bordered" style="width:100%">
  <thead>
    <tr>
      <th style="text-align:center">Time</th>
      <th style="text-align:center">Author</th>
      <th style="text-align:center">Title</th>
      <th style="width:20%">Status</th>
      <th style="text-align:center">Labels</th>
      <th style="text-align:center">Changes</th>
      <th style="text-align:center">Reviewed</th>
      <th style="text-align:center">Approved</th>
      <th style="text-align:center">Last event</th>

    </tr>
  </thead>
  <tbody>
    {% set max_changes=max_changes %}
    {% for pull in pull_requests %} 
      <tr>
        {% set author = pull.get_login() %}
        
        <td> Created {{ moment(pull.get_created()).fromNow() }} </td>
        <td style="text-align:center"> 
          <img src="{{ people[author].avatar }}" style="width:55px;height:55px;"> <br>
          {{ author }}
          <br> {{ people[author].association }} 
        </td>
        <td style="text-align:center">{{ pull.get_title() }} 
          <p>
          <button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#{{pull.get_number()}}" aria-expanded="false" >
                Show description 
              </button>
            </p>
            <div class="collapse" id="{{ pull.get_number() }}">
              <div class="card card-body">
                {{ pull.get_description() }}
              </div>
            </div>
        </td>
        <td> {% set statuses=pull.get_statuses() %}
             {% set tests=pull.get_tests() %}
             {% if "success" in statuses %}
              <button class="btn btn-success" type="button" data-toggle="collapse" data-target="#{{pull.get_number()}}_succ" aria-expanded="false" style="width:100px;">
              {{ statuses["success"] }} success
                </button>
                <div class="collapse" id="{{ pull.get_number() }}_succ">
                  <div class="card card-body" style="overflow-y: scroll; height:200px;">
                  <table class="table table-condensed">
                    {% for test in tests["success"] %}
                      <tr> 
                        <td>
                          {{ test.context }} 
                          <br>
                          <font color="grey">{{ moment(test.time).fromNow() }} </font>
                        </td>
                      </tr> 
                    {% endfor %}
                  </table>
                  </div>
                </div>
              <br>
             {% endif %}
             {% if "pending" in statuses %}
              <button class="btn btn-warning" type="button" data-toggle="collapse" data-target="#{{pull.get_number()}}_pend" aria-expanded="false" style="width:100px;" >
              {{ statuses["pending"] }} pending
                </button>
                <div class="collapse" id="{{ pull.get_number() }}_pend">
                  <div class="card card-body" style="overflow-y: scroll; height:200px;">
                  <table class="table table-condensed">
                    {% for test in tests["pending"] %}
                      <tr> 
                        <td>
                          {{ test.context }} 
                          <br>
                          <font color="grey">{{ moment(test.time).fromNow() }} </font>
                        </td>
                      </tr> 
                    {% endfor %}
                  </table>
                  </div>
                </div>
              <br>
             {% endif %}
             {% if "error" in statuses or "failure" in statuses %}
              <button class="btn btn-danger" type="button" data-toggle="collapse" data-target="#{{pull.get_number()}}_err" aria-expanded="false" style="width:100px;" >
                {% if statuses["error"] %}
                  {% if statuses["failure"] %}
                    {{ statuses["error"] }} error,
                  {% else %}
                    {{ statuses["error"] }} error
                  {% endif %}
                {% endif %}
                {% if statuses["failure"] %}
                  {{ statuses["failure"] }} failure
                {% endif %}
                </button>
                <div class="collapse" id="{{ pull.get_number() }}_err">
                  <div class="card card-body" style="overflow-y: scroll; height:200px;">
                  <table class="table table-condensed">
                    {% if tests["error"] %}
                      {% for test in tests["error"] %}
                        <tr> 
                          <td>
                            {{ test.context }} 
                            <br>
                            <font color="grey">{{ moment(test.time).fromNow() }} </font>
                          </td>
                        </tr> 
                      {% endfor %}
                    {% endif %}
                    {% if tests["failure"] %}
                      {% for test in tests["failure"] %}
                        <tr> 
                          <td>
                            {{ test.context }} 
                            <br>
                            <font color="grey">{{ moment(test.time).fromNow() }} </font>
                          </td>
                        </tr> 
                      {% endfor %}
                    {% endif %}
                  </table>
                  </div>
                </div>
             {% endif %}
        </td>
        <td> {% for elem in pull.get_labels() %}
             <span class="label" style="background-color: #{{ labels[elem].color }};">{{ elem }} </span>  <br>
             {% endfor %}
        </td>
        <td> {% set changes = pull.get_changes() %}  
             {{ changes.commits }} commits created <br>
             {{ changes.additions }} lines addes <br>
             {{ changes.deletions }} lines deleted <br>
             {% set len=changes.log/max_changes*100 %}
             {% set additions=(changes.additions/changes.total)*len %}
             {% set deletions=(changes.deletions/changes.total)*len %}
             <div class="progress">
               <div class="progress-bar progress-bar-success" style="width: {{ additions }}%">
                 <span class="sr-only"> {{ changes.additions }} lines added </span>
               </div>
               <div class="progress-bar progress-bar-danger" style="width: {{ deletions }}%">
                 <span class="sr-only"> {{ changes.deletions }} lines deleted </span>
               </div>
             </div>

        </td>
        <td> {% for person in pull.get_reviewed_by() %}
             <img src="{{ people[person].avatar }}" style="width:55px;height:55px;"> 
             {% endfor %}
        </td>
        <td> {% for person in pull.get_approved_by() %}
             <img src="{{ people[person].avatar }}" style="width:55px;height:55px;"> 
             {% endfor %}
        </td>
        <td> {% set action = pull.get_last_action() %}
                {% if action %}
                  {% if action == "commited" %}
                    <img src="{{ people[author].avatar }}" style="width:55px;height:55px;"> made a commit 
                  {% else %}
                    <img src="{{ people[action.person].avatar }}" style="width:55px;height:55px;"> {{ action.event }}
                  {% endif %}
                  <br> {{ moment(pull.get_last_update()).fromNow() }} 
                {% endif %}
        </td>

      </tr>
    {% endfor %}
    </tbody>


{% endblock %}


