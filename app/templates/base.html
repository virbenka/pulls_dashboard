{% extends 'bootstrap/base.html' %}

{% block title %}
    {% if title %}{{ title }} {% else %} Pulls dashboard {% endif %}
{% endblock %}


{% block navbar %}
    <nav class="navbar navbar-default">
        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand" href="{{ url_for('choice') }}">Home</a>
                {% if settings %}
                  <a class="navbar-brand" href="{{ url_for('dashboard_settings', name=name, owner=owner) }}">Dashboard settings</a>
                {% endif %}
                  
            </div>
        </div>
    </nav>
{% endblock %}

{% block content %}
    <div class="container">
        {% with messages = get_flashed_messages() %}
        {% if messages %}
            {% for message in messages %}
            <div class="alert alert-info" role="alert">{{ message }}</div>
            {% endfor %}
        {% endif %}
        {% endwith %}

        {# application content needs to be provided in the app_content block #}
        {% block app_content %}{% endblock %}
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    {{ moment.include_moment() }}
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"> </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.bundle.min.js"> </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.9/dist/js/bootstrap-select.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>


    <script>
    $(document).ready(function() {
      $('.labels').select2();
    });
    $(document).ready(function() {
      $('.people').select2();
    });
    </script>
    <script>
      function filterTable() {
        let dashboard = document.getElementById('Dashboard');
        let rows = dashboard.rows;
        var current_labels, author, current_people, found;
        var rows_display = {};
        let filters_num = 0;
        for (var type in filters) {
          console.log(type);
          if (type == "labels") {
            if (filters[type].length > 0) {
              filters_num += 1;
            } else {
              continue;
            }
            console.log("LABELS");
            for (i = 1; i < rows.length; i++) {
              found = 0;
              current_labels = rows[i].getElementsByClassName('label');
              for (j = 0; j < current_labels.length; ++j) {
                if (filters[type].indexOf(current_labels[j].textContent) > -1) {
                  found += 1;
                }
              }
              if (found == filters[type].length) {
                if (rows_display[i]) {
                  rows_display[i] += 1;
                } else {
                  rows_display[i] = 1;
                }
              }
            }
            console.log(rows_display);
          }
          else if (type == "people") {
            if (filters[type].length > 0) {
              filters_num += 1;
            } else {
              continue;
            }
            for (i = 1; i < rows.length; i++) {
              author = rows[i].getElementsByClassName('author')[0].id;
              if (filters[type].indexOf(author) > -1) {
                if (rows_display[i]) {
                  rows_display[i] += 1;
                } else {
                  rows_display[i] = 1;
                }
              }
            }
          }
        }
        if (filters_num > 0) {
          console.log("not empty")
          for (i = 1; i < rows.length; i++) {
            if (rows_display[i] == filters_num) {
              rows[i].style.display = "";
            } else {
              rows[i].style.display = "none";
            }
          }
        } else {
          for (i = 1; i < rows.length; i++) {
            console.log("HEHEHEHE")
            rows[i].style.display = "";
          }
        }
      }

    </script>
    <script>
      var filters = {'a':3};
      var targetProxy = new Proxy(filters, {
        set: function (target, key, value) {
          console.log(`${key} set to ${value}`);
          filters[key] = value;
          filterTable();
          return true;
        }
      });

      targetProxy.hello_world = "test";
     $(filters).change(function() {
       console.log(filters, ";l;l;l");
     });
     $('.people').change(function () {
        var selectedItem = $('.people').val();
        targetProxy.people = selectedItem;
      });
     $('.labels').change(function () {
        var selectedItem = $('.labels').val();
        targetProxy.labels = selectedItem;
      });
    </script>
    <script>
      $('tbody tr').hover(function(){
        $(this).find('td').addClass('hovered');
      }, function(){
        $(this).find('td').removeClass('hovered');
      });
    </script>
    <script>
      const searchFun = () => {
        let filter = document.getElementById('searchbar').value.toUpperCase();
        let dashboard = document.getElementById('Dashboard');
        let tr = dashboard.getElementsByTagName('tr');
        for (i = 0; i < tr.length; i++) {  
          let td = tr[i].getElementsByTagName('td')[2];
          if(td){
            let title = td.getElementsByClassName('title')[0]
            let textvalue = title.textContent || title.innerHTML;
              if(textvalue.toUpperCase().indexOf(filter) > -1) {
                tr[i].style.display = "";
              }else{
                tr[i].style.display="none";
              }
          }
        }
      }
    </script>
    <script>
      function getTestsCounter(row, type){
        let info = row.getElementsByClassName('tests')[0].getElementsByClassName(type)[0];
        if (typeof(info) != 'undefined') {
          return Number(info.id);
        }
        return Number('0');
      }
    </script>
    <script>
      function sortTable(column_) {
        console.log("started")
        var table;
        table = document.getElementById("Dashboard");
        var rows, i, x, y, count = 0;
        var switching = true;
        var sorted = false;
        // Order is set as ascending
        var direction = "descending";

        // Run loop until no switching is needed
        while (switching) {
            switching = false;
            var rows = table.rows;
            //Loop to go through all rows
            for (i = 1; i < (rows.length - 1); i++) {
                var Switch = false;

                // Fetch 2 elements that need to be compared
                if (column_ =="title"){
                  x = rows[i].getElementsByTagName("td")[2].getElementsByTagName('font')[0].children[0].outerHTML;
                  y = rows[i + 1].getElementsByTagName("td")[2].getElementsByTagName('font')[0].children[0].outerHTML;
                } else if (column_ =="updated") {
                  x = rows[i].getElementsByClassName('updated')[0].getElementsByTagName('font')[0].children[0].outerHTML;
                  y = rows[i + 1].getElementsByClassName('updated')[0].getElementsByTagName('font')[0].children[0].outerHTML;
                } else if (column_ == "changes") {
                  x = Number(rows[i].getElementsByClassName('changes')[0].id)
                  y = Number(rows[i+1].getElementsByClassName('changes')[0].id)
                } else if (column_ == "tests") {
                  if (direction == "descending") {
                    let succ_1 = getTestsCounter(rows[i], "success");
                    let succ_2 = getTestsCounter(rows[i+1], "success");
                    if (succ_1 < succ_2) {
                      Switch = true;
                      break;
                    } else if (succ_1 == succ_2) {
                      let fail_1 = getTestsCounter(rows[i], "failure")+getTestsCounter(rows[i], "error");
                      let fail_2 = getTestsCounter(rows[i+1], "failure")+getTestsCounter(rows[i+1], "error");
                      if (fail_1 > fail_2) {
                        Switch = true;
                        break;
                      }
                    }
                  } else {
                    let fail_1 = getTestsCounter(rows[i], "failure")+getTestsCounter(rows[i], "error");
                    let fail_2 = getTestsCounter(rows[i+1], "failure")+getTestsCounter(rows[i+1], "error");
                    if (fail_1 < fail_2) {
                      Switch = true;
                      break;
                    } else if (fail_1 == fail_2) {
                      let succ_1 = getTestsCounter(rows[i], "success");
                      let succ_2 = getTestsCounter(rows[i+1], "success");
                      if (succ_1 > succ_2) {
                        Switch = true;
                        break;
                      }
                    }
                  }


                }
                // Check the direction of order
                if (direction == "ascending") {

                    // Check if 2 rows need to be switched
                    if (x > y)
                        {
                        // If yes, mark Switch as needed and break loop
                        Switch = true;
                        break;
                    }
                } else if (direction == "descending") {

                    // Check direction
                    if (x < y)
                        {
                        // If yes, mark Switch as needed and break loop
                        Switch = true;
                        break;
                        }
                }
            }
            if (Switch) {
                // Function to switch rows and mark switch as completed
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;

                // Increase count for each switch
                count++;
            } else {
                // Run while loop again for descending order
                if (count == 0 && direction == "descending") {
                      sorted = true;
                      direction = "ascending";
                      switching = true;
                }
            }
        }
    }
  </script>

{% endblock %}

